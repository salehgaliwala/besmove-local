/*! Thrive Leads - The ultimate Lead Capture solution for wordpress - 2018-01-24
* https://thrivethemes.com 
* Copyright (c) 2018 * Thrive Themes */

var TL_Editor=TL_Editor||{},TCB_AnimViews=TVE.Views.Components.AnimationViews;TL_Editor.views=TL_Editor.views||{},TVE.leads=TVE.leads||{},TL_Editor.views.ModalTemplates=TVE.modal.base.extend({el:TVE.modal.get_element("tl-templates"),saved_tpl_delete_confirmation:TVE.tpl("landing-pages/delete-confirmation"),events:function(){return _.extend({},TVE.modal.base.prototype.events(),{"click .tcb-cancel-delete-template":"no_delete_template","click .tcb-apply-delete-template":"yes_delete_template","click .tcb-modal-cancel":"close","click .tcb-modal-save":"save","click .tab-item":"tab_click","click .tve-template-item .template-wrapper":function(a){this.$(".template-wrapper.active").removeClass("active"),a.currentTarget.classList.toggle("active")}})},initialize:function(){TVE.modal.base.prototype.initialize.apply(this,arguments),this.$tabs=this.$(".tab-item"),this.$content=this.$(".tve-tab-content"),this.$default_templates=this.$(".tve-default-templates-list"),this.$saved_templates=this.$(".tve-saved-templates-list"),this.set_templates(TVE.CONST.tl_templates)},delete_confirmation:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item");b.find(".template-wrapper").hide(),b.append(this.saved_tpl_delete_confirmation())},no_delete_template:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item");b.find(".template-wrapper").show(),b.find(".tcb-delete-template-confirmation").remove()},yes_delete_template:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item"),c={external_action:tve_leads_page_data.tpl_action,route:"delete",tpl:b.attr("data-id"),post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key};TVE.main.overlay(),TVE.ajax("save_post_external","post",c).done(function(a){b.remove(),TVE.main.overlay("close")})},has_fixed_footer:function(){return!0},save:function(){var a=this,b=this.$(".tve-template-item .active");if(b.length<=0)return TVE.page_message(TVE.t.SelectTemplate,!0,5e3);var c=b.data("id"),d=this.templates.findWhere({id:c});if(!(d instanceof Backbone.Model))return TVE.page_message("Something is wrong here. Template model not found ",!0);var e={tpl:d.get("key"),external_action:tve_leads_page_data.tpl_action,post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key,route:"choose",cloud:d.get("cloud")||0,multi_step:d.get("multi_step")||0,form_type:d.get("form_type")||""};TVE.main.overlay(),jQuery("#tl-form-states").find(".design-states").is(":visible")&&jQuery("#tl-form-states").find("button.state-close").trigger("click"),TVE.ajax("save_post_external","post",e).done(function(b){if(!b.success&&!b.main_page_content&&1)return TVE.page_message(b.message,!0),TVE.main.overlay("close");TL_Editor.state.insertResponse(b),a.close()})},tab_click:function(a){var b=a.currentTarget.getAttribute("data-content");"saved"===b?this.render_saved_templates():this.templates=new Backbone.Collection(TVE.CONST.tl_templates),this.$tabs.removeClass("active"),a.currentTarget.classList.add("active"),this.$content.removeClass("active"),this.$content.filter('[data-content="'+b+'"]').addClass("active")},before_open:function(){this.render_templates(),this.$('.tab-item[data-content="default"]').trigger("click")},render_templates:function(){if(this.$default_templates.html().length>0)return this;var a=this,b=TVE.tpl("templates/item");this.templates.each(function(c,d,e){a.$default_templates.append(b({item:c}))})},render_saved_templates:function(){var a=this,b={external_action:tve_leads_page_data.tpl_action,route:"get_saved",current_template:this.$("#tl-filter-current-templates").is(":checked")?1:0,post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key};TVE.main.overlay(),a.$saved_templates.html("Fetching saved templates..."),TVE.ajax("save_post_external","post",b).done(function(b){if(!b.success&&!b.main_page_content&&1)return TVE.page_message(b.message,!0),TVE.main.overlay("close");a.$saved_templates.empty();var c=TVE.tpl("templates/saved-item");a.templates=new Backbone.Collection(b.templates),0===a.templates.length?a.$saved_templates.append("No saved templates found"):a.templates.each(function(b,d,e){a.$saved_templates.append(c({item:b}))}),TVE.main.overlay("close")})},set_templates:function(a){this.templates=new Backbone.Collection(a),this.$default_templates.empty()}}),TL_Editor.views.ModalTemplateSaving=TVE.modal.base.extend({el:TVE.modal.get_element("tl-template-saving"),after_initialize:function(){this.$el.addClass("medium")},save:function(){var a=this.$("input").val();if(a.length<=0)return TVE.page_message(TVE.t.tpl_name_required,!0,5e3);var b=this,c={external_action:tve_leads_page_data.tpl_action,route:"save",post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key,name:a};return TVE.main.overlay(),TVE.ajax("save_post_external","post",c).done(function(a){if(!a.success&&1)return TVE.page_message(a.message,!0),TVE.main.overlay("close");TVE.main.overlay("close"),b.close(),TVE.page_message(a.message)}),this}}),TVE.leads.LightboxStateAction=TCB_AnimViews.ThriveLightbox.extend({reinit:function(){this.options.actions[this.key]?(this.$el.closest(".action-item").show(),this.list.set_items(this.options.actions[this.key].options)):this.$el.closest(".action-item").hide()},controls_init:function(){this.list=new TVE.Views.Controls.List({el:this.$(".state-list")[0],items:this.options.actions[this.key].options}),this.event_trigger="click",this.$animation=this.$("#lb-animation"),TVE.CONST.options.animation.actions.tl_state_lightbox?(this.$animation.show(),_.each(TVE.CONST.options.animation.actions.tl_state_lightbox.animations,function(a,b){this.$animation.append('<option value="'+b+'">'+a+"</option>")},this)):this.$animation.hide()},set_model:function(a){return this.model=void 0!==a?a:new Backbone.Model({config:{}}),this.list.set_value(parseInt(this.model.get("config").s||0)),this.$animation.val(this.model.get("config").anim||"instant"),this},validate:function(){return!!this.list.get_value()||TVE.page_message(TVE.t.state_missing,!0)},apply_settings:function(a){return!!this.validate()&&(this.model.set({a:this.key,t:this.event_trigger,config:{anim:this.$animation.val()||"instant",s:this.list.get_value()}}),!0)}}),TVE.leads.StateSwitchAction=TVE.leads.LightboxStateAction.extend({}),function(a){TVE.add_filter("tve_form_submit_options",function(a){return a.push({key:"state",label:tve_leads_page_data.L.switch_state,css_class:"tcb-lg-option-switch_state",icon:"state"}),a}),a(function(){new TVE.leads.StateManager({el:a("#tl-form-states")[0]});TVE.add_filter("editor_loaded_callback",TL_Editor.tcb_editor_page_loaded),TVE.add_filter("before_editor_events",TL_Editor.before_editor_loaded),TVE.add_filter("tcb_insert_content_template",TL_Editor.pre_process_content_template),TVE.main.on("animation_update",function(b,c){var d=c.read(b);a.each(d,function(d,e){var f=e.a;if("thrive_leads_form_close"!==f){var g=parseInt(e.config.s),h=e.t,i=TVE.Components.animation.options.actions;if("click"===h){var j=i[f].options,k=[];j.length?(a.each(j,function(a,b){b.id===g&&k.push(b.id)}),k.length||c.remove(b,h)):c.remove(b,h)}}})})}),TVE.leads.StateManager=TVE.Views.Base.base_view.extend({after_initialize:function(){this.dom={btn:this.$(".states-button-container")},TL_Editor.state.fixed_height()},expand:function(){this.$(".design-states").show(),this.dom.btn.hide()},collapse:function(){this.$(".design-states").hide(),this.dom.btn.show()},toggle_add:function(b){a(b.currentTarget).toggleClass("tl-multistep-open")},add:function(a){var b=a.currentTarget;if(b.getAttribute("data-subscribed"))return void alert(tve_leads_page_data.L.only_one_subscribed);this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TL_Editor.state.ajax({custom_action:"add",state:b.getAttribute("data-state")}).done(TL_Editor.state.insertResponse)})},select:function(a){this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TL_Editor.state.ajax({custom_action:"display",id:a.currentTarget.getAttribute("data-id")}).done(TL_Editor.state.insertResponse)})},visibility:function(b){var c=a(b.currentTarget);if(c.parents("li").hasClass("lightbox-step-active")&&void 0!==c.attr("data-visible"))return TVE.main.overlay(),this.collapse(),TL_Editor.state.ajax({custom_action:"visibility",visible:c.attr("data-visible")}).done(function(a){TVE.page_message(a.message),TL_Editor.state.insertResponse(a)}),!1},duplicate:function(a,b){return"already_subscribed"===b.getAttribute("data-state")?void alert(tve_leads_page_data.L.only_one_subscribed):(this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TL_Editor.state.ajax({custom_action:"duplicate",id:b.getAttribute("data-id")}).done(TL_Editor.state.insertResponse)}),!1)},remove:function(a,b){return!!confirm(tve_leads_page_data.L.confirm_state_delete)&&(this.collapse(),TVE.main.overlay(),TL_Editor.state.ajax({custom_action:"delete",id:b.getAttribute("data-id")}).done(function(a){TVE.page_message(tve_leads_page_data.L.state_deleted),TL_Editor.state.insertResponse(a)}),!1)}}),TL_Editor.state={fixed_height:function(){var b=a(".fix-height-states");"function"==typeof b.scrollbar?b.scrollbar():b.css("overflow-y","auto")},insertResponse:function(b){b||TVE.page_message("Something went wrong",!0),TVE.main&&TVE.main.$cpanel&&b.preview_link.length&&TVE.main.$cpanel.find(".preview-content").attr("href",decodeURIComponent(b.preview_link)),TL_Editor_Page.handle_state_response(b),a(".design-states").replaceWith(b.state_bar),TL_Editor.state.fixed_height(),b.tve_path_params.tl_templates&&modal_templates.set_templates(TVE.CONST.tl_templates),b.animation_options&&(TVE.Components.animation.options=b.animation_options,TVE.Components.animation.reinit(),TL_Editor.FLAG_RE_RENDER_EVENTS=!0);var c=a(".total_states");b.tve_leads_page_data.states.length>=2?(c.show(),c.html(b.tve_leads_page_data.states.length-1)):c.hide(),setTimeout(function(){TVE.main.overlay("close")},1)},ajax:function(a){return TVE.Editor_Page.blur(),a._key=tve_leads_page_data._key,a.post_id=tve_leads_page_data.post_id,a.active_state=tve_leads_page_data._key,a.external_action=tve_leads_page_data.state_action,TVE.ajax("save_post_external","post",a)}},TVE.leads.render_from_for_switch_state_option=function(){var b=this,c=TVE.tpl("lead-generation/switch-states-form"),d=a(c()),e=d.find("select");e.on("change",function(a){b.model.set("_state",parseInt(a.currentTarget.value))}),a.each(tve_leads_page_data.states,function(c,d){if(parseInt(d.key)!==parseInt(tve_leads_page_data._key)&&"already_subscribed"!==d.form_state){var f=a('<option value="'+d.key+'">'+d.state_name+"</option>");parseInt(d.key)===parseInt(b.model.get("_state"))&&f.attr("selected","selected"),e.append(f)}}),this._get_form_wrapper().html(d).show(0),this.model.get("_state")&&parseInt(this.model.get("_state"))===parseInt(e.val())||this.model.set("_state",parseInt(e.val()))},TL_Editor.tcb_editor_page_loaded=function(){modal_templates=new TL_Editor.views.ModalTemplates,TVE.Components.lead_generation.on("tcb_lg_manage_submit_options",function(b,c){b.render_form_state=TVE.leads.render_from_for_switch_state_option,c._read.state=function(){var a=parseInt(this.$("#_state").val());"number"!=typeof a||isNaN(a)||this.model.set("_state",a)},c.read("state"),b.on("tcb_lg_write_submit_option",function(a,b){"state"!==a&&b instanceof Backbone.View&&(b.$el.find("#_state").remove(),b.$el.find(".tve-switch-state-trigger").remove())}),b.on("tcb_lg_write_submit_option_state",function(b){b._write.switch_state=function(){var b=this.$("#_state");b.length>0?b.val(parseInt(this.model.get("_state"))):this.get_wrapper("form").append(this._write.renderHiddenInput({name:"_state",value:this.model.get("_state")}));var c="tl_state_switch",d=this.model.get("_state");a(tve_leads_page_data.states).each(function(a,b){parseInt(d)===parseInt(b.key)&&"lightbox"===b.form_state&&(c="tl_state_lightbox")});var e={t:"click",a:c,elementType:"a",config:{s:d}};e="__TCB_EVENT_["+JSON.stringify(e)+"]_TNEVE_BCT__",this.$(".tve-switch-state-trigger").remove();var f=a('<a href="javascript:void(0)" style="display: none;" class="tve-switch-state-trigger tve_evt_manager_listen tve_et_click"></a>');f.attr("data-tcb-events",e),this.get_wrapper("form").append(f)},b.write("switch_state")})}),TVE.main.sidebar_settings.tl_template_chooser=function(a){a=a||{},modal_templates.open(a)},tve_leads_page_data.has_content||TVE.main.sidebar_settings.tl_template_chooser({dismissible:!1}),TVE.main.sidebar_settings.tl_template_reset=function(){if(confirm(tve_leads_page_data.L.confirm_tpl_reset)){var a={_key:tve_leads_page_data._key,post_id:TVE.CONST.post_id,external_action:tve_leads_page_data.tpl_action,route:"reset"};TVE.main.overlay(),TVE.ajax("save_post_external","post",a).done(TL_Editor.state.insertResponse)}},TVE.main.sidebar_settings.tl_template_save=function(){(new TL_Editor.views.ModalTemplateSaving).open()},TVE.add_filter("link_search_lightbox",function(){return""}),TVE.add_filter("tcb_save_post_data_before",function(a){if(TVE.inner_$(".tve_p_lb_content").length){var b,c=TVE.CONST.tve_globals,d=TVE.inner_$(".tve_p_lb_content");(b=d.attr("data-css"))&&(c.content_css=b)}return a})},TL_Editor.before_editor_loaded=function(){var b=1,c=["thrive_leads_form_close","tl_state_lightbox","tl_state_switch"];TVE.add_filter("tcb_froala_config",function(){return{linkEventActions:{getHtml:function(){var a=TVE.Components.animation.options.actions,c={thrive_leads_form_close:a.thrive_leads_form_close};return a.tl_state_switch&&a.tl_state_switch.options.length&&(c.tl_state_switch=a.tl_state_switch),a.tl_state_lightbox&&a.tl_state_lightbox.options.length&&(c.tl_state_lightbox=a.tl_state_lightbox),TVE.tpl("froala-leads-states")({actions:c,current_id:++b})},bindEvents:function(a){a.on("change",".fr-extra-action",function(b){a.find(".tl-action-config").hide(),this.checked?(a.find(".tl-action-opts-"+this.getAttribute("data-key")).show(),a.find(".fr-link-atts,.fr-link-url").hide(),a.find(".fr-extra-action").not(this).prop("checked",!1)):a.find(".fr-link-atts,.fr-link-url").show()})},hasSelected:function(a){return a.find(".fr-extra-action:checked").length},getEventConfig:function(a){var b={};return b.a=a.find(".fr-extra-action:checked").attr("data-key"),b.t="click",b.config={s:a.find(".tl-action-opts-"+b.a+' select[name="s"]').val(),anim:a.find(".tl-action-opts-"+b.a+' select[name="a"]').val()},b},reset:function(a){TL_Editor.FLAG_RE_RENDER_EVENTS&&(a.find(".tl-link-actions").replaceWith(this.getHtml()),delete TL_Editor.FLAG_RE_RENDER_EVENTS),a.find(".fr-extra-action").prop("checked",!1),a.find(".fr-link-atts,.fr-link-url").show(),a.find(".tl-action-config").hide()},updateFromLink:function(b,d){var e=!1;if(this.reset(d),b.hasClass("tve_evt_manager_listen")){var f=TVE.EventManager.get(b,"click");f&&-1!==a.inArray(f.a,c)&&(d.find('.fr-extra-action[data-key="'+f.a+'"]').prop("checked",!0).trigger("change"),d.find(".tl-action-opts-"+f.a+' select[name="s"]').val(f.config.s),e=!0,d.find(".tl-action-opts-"+f.a+' select[name="a"]').val(f.config.anim||"instant"))}return e}}}})}}(jQuery);
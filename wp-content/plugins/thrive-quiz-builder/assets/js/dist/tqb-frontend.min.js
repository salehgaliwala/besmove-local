/*! Thrive Quiz Builder - 2018-01-24
* http://www.thrivethemes.com/
* Copyright (c) 2018 Thrive Themes */

var ThriveQuizB=ThriveQuizB||{};ThriveQuizB.models=ThriveQuizB.models||{},ThriveQuizB.collections=ThriveQuizB.collections||{},function(a){a(function(){ThriveQuizB.models.Base=Backbone.Model.extend({idAttribute:"ID",validation_error:function(a,b){return{field:a,message:b}},custom_action:function(a,b,c){b||(b={});var d=_.extend({type:"post",dataType:"json",url:this.url()+"&custom_action="+c,data:b},a);return jQuery.ajax(d)}}),ThriveQuizB.collections.Base=Backbone.Collection.extend({last:function(){return this.at(this.size()-1)}}),ThriveQuizB.models.Shortcode=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,quiz_id:null,user_unique:null,page_type:"",page:{page_id:null,variation_id:null,html:"",css:"",fonts:""},question:null},url:function(){return ThriveQuizB.ajaxurl("&route=shortcode")},logSocialShareConversion:function(a,b){this.custom_action(a,b,"log_social_share_conversion")},saveUserCustomSocialShareBadge:function(a,b){this.custom_action(a,b,"save_user_custom_social_share_badge")}}),ThriveQuizB.models.Question=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,question_id:null,type:null,text:"",image:"",description:""},get_image:function(){return"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.full.url}}),ThriveQuizB.models.Answer=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,order:null,text:"",image:""},get_image:function(){return"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.full.url}}),ThriveQuizB.collections.Shortcodes=ThriveQuizB.collections.Base.extend({model:ThriveQuizB.models.Shortcode}),ThriveQuizB.collections.Answers=ThriveQuizB.collections.Base.extend({model:ThriveQuizB.models.Answer})})}(jQuery);var ThriveQuizB=ThriveQuizB||{};ThriveQuizB.views=ThriveQuizB.views||{},function(a){a(function(){ThriveQuizB.views.Base=Backbone.View.extend({render:function(){return this}}),ThriveQuizB.views.ShortcodeList=ThriveQuizB.views.Base.extend({events:{},el:a("body"),render:function(){this.collection.each(this.renderOne,this)},renderOne:function(a){if(a.get("page").html||a.get("question")){new ThriveQuizB.views.Shortcode({model:a,collection:this.collection,el:this.$el.find("#tqb-shortcode-wrapper-"+a.get("quiz_id")+"-"+a.get("id"))}).render()}a.get("error")&&TQB_Front.is_preview&&this.$el.find("#tqb-shortcode-wrapper-"+a.get("quiz_id")+"-"+a.get("id")).find(".tqb-frontend-error-message").html(a.get("error"))}}),ThriveQuizB.views.Shortcode=ThriveQuizB.views.Base.extend({events:{"click .tqb-shortcode-new-content .tqb-shortcode-submit-action":"nextPage","click .tqb-shortcode-new-content .tve_evt_manager_listen":"runEvent","click .tqb-btn-start":"startQuiz"},to_load:0,sec_delay:1,powered_by_tqb:ThriveQuizB.tpl("powered-by-thrive-themes"),render:function(){return this.showLoader(),this.loadScripts(),this.initListeners(this.model),this.hideLoader(),this},loadScripts:function(){var b=this,c=[];this.$el.find(".tqb-shortcode-new-content").html(""),this.model.get("page")&&(c=c.concat(this.model.get("page").css),c=c.concat(this.model.get("page").fonts)),this.model.get("question")&&(c=c.concat(this.model.get("question").css)),this.to_load=c.length,_.each(c,function(c,d,e){var f=a('<link rel="stylesheet" type="text/css" media="all" href="'+c+'">');this.$el.find(".tqb-shortcode-new-content").append(f),f.load(function(){b.to_load--})},this),this.check_loaded()},loadHTML:function(){var a=this;_.isEmpty(this.model.get("page"))?(this.template=ThriveQuizB.tpl("question-wrapper"),this.$el.find(".tqb-shortcode-new-content").append(this.template()),this.renderQuestion(),TQB_Front.settings.tqb_promotion_badge&&this.$el.find(".tqb-shortcode-new-content .tqb-question-wrapper").append(this.powered_by_tqb()),this.model.trigger("tqb:close_loader",this.model)):(this.template=_.template(this.model.get("page").html,ThriveQuizB.templateSettings),this.$el.find(".tqb-shortcode-new-content").append(this.template(this.model.toJSON())),this.$el.find(".tqb-shortcode-new-content").append('<style type="text/css">'+this.model.get("page").user_css.replace(/\\/g,"")+"</style>"),this.setUserIdentifier(),this.listener(),TQB_Front.settings.tqb_promotion_badge&&this.$el.find(".tqb-shortcode-new-content .tve-tqb-page-type").append(this.powered_by_tqb()),"results"===this.model.get("page_type")?this.resultPageListener():this.model.trigger("tqb:close_loader",this.model)),setTimeout(function(){a.hideLoader(),a.setOverlayHeight()},50),TCB_Front.event_triggers(ThriveGlobal.$j(this.$el)),TCB_Front.onDOMReady(),ThriveGlobal.$j(TCB_Front).trigger("content_loaded.thrive",[this.$el.find(".tqb-shortcode-new-content")])},check_loaded:function(){var a,b=this;if(this.to_load<=0)return this.loadHTML(),void clearTimeout(a);a=setTimeout(function(){b.check_loaded()},50)},startQuiz:function(){jQuery("body").animate({scrollTop:jQuery(".tqb-shortcode-wrapper").offset().top-jQuery("header").height()-50},"slow")},runEvent:function(b){b.preventDefault();for(var c=a(b.currentTarget).attr("data-tcb-events"),d=!1,e=ThriveGlobal.$j.parseJSON(c.replace("__TCB_EVENT_","").replace("_TNEVE_BCT__","")),f=0,g=e.length;f<g;f++)"thrive_quiz_next_step"===e[f].a&&(d=!0);d&&this.shortcodeAction()},setUserIdentifier:function(){this.$el.find(".tqb-hidden-form-info.tqb-hidden-user-unique").val(this.model.get("user_unique"))},setOverlayHeight:function(){var a=this.$el.find(".tqb-shortcode-new-content").outerHeight();this.$el.find(".tqb-loading-overlay").css({height:a+"px"})},listener:function(){var a=this;ThriveGlobal.$j(this.$el).off("lead_conversion_success.tcb").on("lead_conversion_success.tcb",".thrv_lead_generation",function(b){b.content_unlocked="results"!==a.model.get("page_type"),a.nextPage()}),ThriveGlobal.$j(this.$el).off("should_submit_form.tcb").on("should_submit_form.tcb",".thrv_lead_generation",function(a){return a.flag_need_data=!0,!0})},switchContent:function(){var a=this.$el.find(".tqb-shortcode-old-content"),b=this.$el.find(".tqb-shortcode-new-content");a.html(b.html())},nextPage:function(){this.shortcodeAction()},shortcodeAction:function(a){if("results"!=this.model.get("page_type")){this.hideErrorToast(),this.model.trigger("tqb:show_loader",this.model);var b=a?this.getQuestionData(a):this.getPageData(),c=this;this.model.fetch({data:b,success:function(a,b,d){c.render()},error:function(a,b,c){}})}},hideErrorToast:function(){a("#tve-lg-error-container").hide()},getQuestionData:function(a){return{user_unique:this.model.get("user_unique"),quiz_id:this.model.get("quiz_id"),page_type:this.model.get("page_type"),answer_id:a.get("id")}},getPageData:function(){return{user_unique:this.model.get("user_unique"),quiz_id:this.model.get("quiz_id"),page_type:this.model.get("page_type"),variation:{page_id:this.model.get("page").page_id,id:this.model.get("page").variation_id}}},renderQuestion:function(){var a=new ThriveQuizB.collections.Answers(this.model.get("question").answers),b=this;a.on("tqb:answer_question",function(a){setTimeout(function(){b.shortcodeAction(a)},b._get_delay())});var c=this.model.get("question").data;return c.quiz_type=this.model.get("quiz_type"),new ThriveQuizB.views.Question({model:new ThriveQuizB.models.Question(c),collection:a,el:this.$el.find(".tqb-shortcode-new-content .tqb-question-wrapper")}).render()},resultPageListener:function(){function b(){j.removeAttr("data-image"),k.removeAttr("src"),i.children().hide(),i.append(h)}function c(a){m++,k.attr("src",a),2===m&&j.attr("data-image",a);var b=e.model.get("quiz_url"),c="";c+="&tqb_redirect_post_id="+TQB_Front.post_id,c+="&image_url="+a,c+="&description="+encodeURIComponent(j.attr("data-description")),-1===b.indexOf("?")&&(c+="?"+c.substr(1)),b+=c,j.attr("data-href",b),ThriveGlobal.$j(tve_frontend_options.is_editor_page?"#tve_editor":"body").on("click",".tqb-social-share-badge-container .tve_s_link",function(){e.model.logSocialShareConversion({},{page_id:e.model.get("page").page_id,quiz_id:e.model.get("page").quiz_id,variation_id:e.model.get("page").variation_id,"tqb-variation-user_unique":e.model.get("user_unique")});var a=ThriveGlobal.$j(this).parents(".tve_s_item"),b=a.attr("data-s");TCB_Front.onSocialCustomClick[b]&&TCB_Front.onSocialCustomClick[b](a)}),l.remove()}function d(a){c(a),k.load(function(){h.remove(),i.children().fadeIn();(new Date).getTime()})}var e=this;ThriveGlobal.$j(tve_frontend_options.is_editor_page?"#tve_editor":"body").on("click",".thrv_social_custom .tve_s_link",function(){e.model.logSocialShareConversion({},{page_id:e.model.get("page").page_id,quiz_id:e.model.get("page").quiz_id,variation_id:e.model.get("page").variation_id,"tqb-variation-user_unique":e.model.get("user_unique")})});var f=this.model.get("page").badge_url||null,g=e.model.get("page").has_social_badge&&1==e.model.get("page").has_social_badge&&e.model.get("page").html_canvas&&!f,h=a('<div id="tie-preloader-gif"></div>'),i=e.$(".tqb-social-share-badge-container"),j=i.find(".tve_s_fb_share"),k=i.find("img"),l=a('<div id="tie-html-canvas" style="overflow: visible; position: absolute; z-index: -1; visibility: hidden;">'+(e.model.get("page").html_canvas?e.model.get("page").html_canvas:"")+"</div>"),m=((new Date).getTime(),0);f&&(b(),c(f)),g&&(e.$el.find(".tqb-shortcode-new-content").parents().each(function(b,c){a(c).addClass("tqb-overflow-visible-badge")}),e.$el.find(".tqb-shortcode-new-content").prepend(l),b(),html2canvas([l.get(0)],{onrendered:function(b){var f=b.toDataURL("image/png");c(f),e.$el.find(".tqb-shortcode-new-content").parents().each(function(b,c){a(c).removeClass("tqb-overflow-visible-badge")});var g=function(a){for(var b=atob(a.split(",")[1]),c=[],d=0;d<b.length;)c.push(b.charCodeAt(d)),d++;return new Blob([new Uint8Array(c)],{type:"image/jpg"})}(f),h=new FormData,i=e.model.get("quiz_id"),j=e.model.get("user_id"),k=e.model.get("page").result;h.append("user_badge",g,k+"-"+i+".png"),h.append("quiz_id",i),h.append("user_id",j),h.append("result",k),h.append("action","tqb_frontend_ajax_controller"),a.ajax({type:"post",url:ThriveQuizB.ajaxurl("&route=shortcode&custom_action=save_user_custom_social_share_badge"),data:h,processData:!1,contentType:!1,success:d})}}))},showLoader:function(){this.$el.find(".tqb-loading-overlay").show(),this.$el.find(".tqb-shortcode-new-content").html("")},hideLoader:function(){this.$el.find(".tqb-loading-overlay").hide()},initListeners:function(a){var b=this;a.on("tqb:show_loader",function(a){b.showLoader()}),a.on("tqb:close_loader",function(a){b.hideLoader()})},_get_delay:function(){var a=0;return"right_wrong"===this.model.get("quiz_type")&&1==this.model.get("quiz_highlight_answer")&&(a=1e3*this.sec_delay),a}}),ThriveQuizB.views.Question=ThriveQuizB.views.Base.extend({template:ThriveQuizB.tpl("question"),render:function(){return this.$el.html(this.template({item:this.model})),this.renderAnswers(),!0},renderAnswers:function(){return 2==this.model.get("q_type")&&this.$el.find(".tqb-answers-container").addClass("tqb-answer-has-image"),new ThriveQuizB.views.Answers({model:this.model,collection:this.collection,el:this.$el.find(".tqb-answers-container")}).render()}}),ThriveQuizB.views.Answers=ThriveQuizB.views.Base.extend({events:{},render:function(){return this.collection.each(this.renderOne,this),this},renderOne:function(a){var b=this;a.on("tqb:choose_answer",function(){if(b.collection.trigger("tqb:answer_question",a),"right_wrong"===b.model.get("quiz_type")&&0==a.get("is_right")){var c=b.collection.findWhere({is_right:"1"});c instanceof ThriveQuizB.models.Answer&&c.trigger("tqb:indicate-right")}});var c=new ThriveQuizB.views.Answer({model:a,quiz_type:this.model.get("quiz_type")});this.$el.append(c.render(2==this.model.get("q_type")).$el)}}),ThriveQuizB.views.Answer=ThriveQuizB.views.Base.extend({className:"tqb-answer-inner-wrapper",template:ThriveQuizB.tpl("answer"),template_image:ThriveQuizB.tpl("answer-image"),events:{"click .tqb-answer-action":"answerAction"},right_class:"tqb-right-answer",wrong_class:"tqb-wrong-answer",quiz_type:null,initialize:function(a){a.quiz_type&&(this.quiz_type=a.quiz_type),this.model.on("tqb:indicate-right",this.indicate_right,this)},indicate_right:function(){this.$el.addClass(this.right_class)},render:function(a){var b=a?this.template_image:this.template;return this.$el.html(b({item:this.model})),this},answerAction:function(){this.$el.data("clicked")||(this.$el.attr("data-clicked",1),this.$el.find(".tqb-answer-action").addClass("tqe-selected-answer"),"right_wrong"===this.quiz_type&&this.$el.addClass(1==this.model.get("is_right")?this.right_class:this.wrong_class),this.model.trigger("tqb:choose_answer",this.model),jQuery("body").animate({scrollTop:jQuery(".tqb-answer-action").closest(".tqb-shortcode-new-content").offset().top-jQuery("header").height()-50},"slow"))}})})}(jQuery),function(a){ThriveQuizB.templateSettings=_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},ThriveQuizB.ajaxurl=function(a){var b=-1!==TQB_Front.ajax_url.indexOf("?")?"&":"?";return a&&a.length?(a=a.replace(/^(\?|&)/,""),a+="&_nonce="+TQB_Front.nonce,a+="&tqb-post-id="+TQB_Front.post_id,TQB_Front.ajax_url+b+a):TQB_Front.ajax_url+b+"_nonce="+ThriveQuizB.admin_nonce},ThriveQuizB.tpl=function(b,c){var d=a("script#"+b.replace(/\//g,"-")).html()||"";return d=d.replace(/(\n|\t|\r)/g,""),c?_.template(d,ThriveQuizB.templateSettings)(c):_.template(d,ThriveQuizB.templateSettings)},a.fn.tqb=function(){function b(){window.TVE_Dash&&TVE_Dash.add_load_item("tqb_lazy_load",{quiz_ids:c},function(a){var b=new ThriveQuizB.collections.Shortcodes;Object.keys(a).forEach(function(c){a[c].id=c;var d=new ThriveQuizB.models.Shortcode(a[c]);b.add([d])}),ThriveQuizB.shortcode_list=new ThriveQuizB.views.ShortcodeList({collection:b}),ThriveQuizB.shortcode_list.render()})}var c=(new ThriveQuizB.collections.Shortcodes,{});if(a(".tqb-shortcode-wrapper").each(function(b){var d=a(this).attr("data-quiz-id"),e=a(this).attr("data-unique");c[e]=d}),0===Object.keys(c).length)return!1;!window.FB&&window.tve_frontend_options.social_fb_app_id&&a.getScript("//connect.facebook.com/en_US/sdk.js",function(){FB.init({appId:window.tve_frontend_options.social_fb_app_id,xfbml:!1,version:"v2.3"})}),window.TVE_Dash&&!TVE_Dash.ajax_sent?a(document).on("tve-dash.load",function(a){b()}):b()},a(function(){a(this).tqb()})}(jQuery);
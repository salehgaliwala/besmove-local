/*! Thrive Graph Editor - 2018-01-24
* http://www.thrivethemes.com/
* Copyright (c) 2018 Thrive Themes */

var TGE_Editor=TGE_Editor||{};TGE_Editor.models=TGE_Editor.models||{},TGE_Editor.collections=TGE_Editor.collections||{},function(a){Backbone.emulateHTTP=!0,Backbone.Collection.prototype.save=function(a){Backbone.sync("update",this,a)},TGE_Editor.models.Base=Backbone.Model.extend({defaults:{},toDeepJSON:function(){var b=a.extend(!0,{},this.attributes);return _.each(_.keys(b),function(a){_.isUndefined(b[a])||_.isNull(b[a])||!_.isFunction(b[a].toJSON)||(b[a]=b[a].toJSON())}),b},validation_error:function(a,b,c){return{field:a,message:b,callback:c}},url:function(b){return b=b||{},b=_.extend({},b,{action:TGE_Editor.ajax_controller_action,_nonce:TGE_Editor.nonce}),TGE_Editor.ajaxurl+"?"+a.param(b)}}),TGE_Editor.models.Question=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{quiz_id:TGE_Editor.quiz.ID,text:"",position:{x:100,y:100}}),initialize:function(a){var b=[];a&&a.image&&this.set("image",new TGE_Editor.models.Image(a.image)),a&&a.answers?(b=new TGE_Editor.collections.Answers(a.answers,{q_type:this.get_type_key()}),this.set("answers",b)):(b=new TGE_Editor.collections.Answers([]),this.set("answers",b))},get_type_key:function(){return 1==this.get("q_type")?"button":"image"},parse:function(a){return a.answers=new TGE_Editor.collections.Answers(a.answers||[]),a.image&&(a.image=new TGE_Editor.models.Image(a.image)),a},validate:function(){var a=[];if(!this.get("text")||0===this.get("text").length)return a.push(this.validation_error("text",TGE_Editor.t.question_text_required)),a;var b=!0;return this.get("answers").each(function(a,c,d){if(b){var e=this.factory_answer(a.toJSON());e.isValid()||(b=!1,a.trigger("invalid",a,e.validationError))}},this),b?(!a.length&&this.get("answers")instanceof Backbone.Collection&&this.get("answers").length<1&&(a=TGE_Editor.t.insufficient_answers),a.length?a:void 0):[]},factory_answer:function(a){var b=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.get("q_type"))});if(!b)return new TGE_Editor.models.Answer(a);var c="Answer";return c+=TVE_Dash.upperFirst(b.get("key")),new TGE_Editor.models[c](a)},url:function(){var a={route:"question"};return this.get("id")&&(a.id=this.get("id")),TGE_Editor.models.Base.prototype.url.call(this,a)},clear_for_duplicate:function(){this.attributes.id="",delete this.attributes.rendered,delete this.attributes.level,delete this.attributes.start,this.attributes.next_question_id=null,this.attributes.previous_question_id=null,this.attributes.views=0,this.attributes.position={x:20+this.attributes.position.x,y:20+this.attributes.position.y},this.attributes.answers.each(function(a,b,c){a.clear_for_duplicate()})}}),TGE_Editor.collections.Questions=Backbone.Collection.extend({model:TGE_Editor.models.Question}),TGE_Editor.models.Answer=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{text:"",points:1}),initialize:function(a){a&&a.image&&this.set("image",new TGE_Editor.models.Image(a.image))},validate:function(){var a=[];return this.get("points").length<=0&&a.push(this.validation_error("points","personality"!==TGE_Editor.quiz.quiz_type?TGE_Editor.t.answer_points_required:TGE_Editor.t.answer_weight_required)),this.get("points")&&(isNaN(this.get("points"))||this.get("points")%1!=0)&&a.push(this.validation_error("points",null,function(a){a.attr("data-position","bottom"),a.attr("data-tooltip",TGE_Editor.t.points_input_number),a.attr("data-class","tvd-red"),a.addClass("tvd-tooltipped"),a.removeClass("tvd-validate"),a.trigger("mouseenter.tooltip")})),a.length?a:a.length?a:void 0},clear_for_duplicate:function(){delete this.attributes.id,delete this.attributes.next_question_id,delete this.attributes.question_id,this.get("image")instanceof TGE_Editor.models.Image&&this.set("image",new TGE_Editor.models.Image(this.get("image").toJSON().attributes))}}),TGE_Editor.models.AnswerImage=TGE_Editor.models.Answer.extend({defaults:_.extend({},TGE_Editor.models.Answer.prototype.defaults,{image:""}),initialize:function(){TGE_Editor.models.Answer.prototype.initialize.apply(this,arguments)},validate:function(){var a=TGE_Editor.models.Answer.prototype.validate.apply(this,arguments)||[];if(this.get("image")&&0!==this.get("image").length||a.push(this.validation_error("image",null,function(a){a.attr("data-position","bottom"),a.attr("data-tooltip",TGE_Editor.t.answer_image_required),a.attr("data-class","tvd-red"),a.addClass("tvd-tooltipped"),a.trigger("mouseenter.tooltip")})),a.length)return a}}),TGE_Editor.models.Image=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{sizes:{thumbnail:{url:null}}}),initialize:function(a){"string"==typeof a&&this.set(_.extend({},this.defaults,{sizes:{full:{url:a},thumbnail:{url:a}},url:a}))},get_thumb:function(){return this.attributes.sizes.thumbnail?this.attributes.sizes.thumbnail.url||this.get("url")||null:this.get("url")||null}}),TGE_Editor.models.AnswerButton=TGE_Editor.models.Answer.extend({defaults:_.extend({},TGE_Editor.models.Answer.prototype.defaults,{}),validate:function(){var a=TGE_Editor.models.Answer.prototype.validate.apply(this,arguments)||[];if(this.get("text").length<=0&&a.push(this.validation_error("text",TGE_Editor.t.answer_text_required)),a.length)return a}}),TGE_Editor.collections.Answers=Backbone.Collection.extend({model:function(a,b){var c="Answer",d=b.q_type?b.q_type:"";return c+=TVE_Dash.upperFirst(d),new TGE_Editor.models[c](a,b)},comparator:function(a,b){return a=a.get("order"),b=b.get("order"),a>b?1:a<b?-1:0}}),TGE_Editor.models.Connection=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{id:""}),url:function(){var a={route:"connection"};return TGE_Editor.models.Base.prototype.url.call(this,a)}}),TGE_Editor.models.Disconnecion=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{id:""}),url:function(){var a={route:"disconnection"};return TGE_Editor.models.Base.prototype.url.call(this,a)}}),TGE_Editor.models.Setting=TGE_Editor.models.Base.extend({defaults:_.extend({},TGE_Editor.models.Base.prototype.defaults,{quiz_id:TGE_Editor.quiz.ID,key:"",value:"",label:""}),modelId:function(){return this.get("key")},url:function(){var a={route:"settings"};return TGE_Editor.models.Base.prototype.url.call(this,a)},is_checked:function(){return void 0!==this.get("value")&&(!0===this.get("value")||this.get("value").length>0)}}),TGE_Editor.models.WeightsSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"Weights",key:"display_weight"})}),TGE_Editor.models.TagsSetting=TGE_Editor.models.Setting.extend({defaults:_.extend({},TGE_Editor.models.Setting.prototype.defaults,{label:"Tags",key:"display_tags"})}),TGE_Editor.collections.Settings=Backbone.Collection.extend({url:function(b){return b=b||{route:"settings"},b=_.extend({},b,{action:TGE_Editor.ajax_controller_action,_nonce:TGE_Editor.nonce}),TGE_Editor.ajaxurl+"?"+a.param(b)},get_model:function(a){var b=this.findWhere({key:a});return b instanceof TGE_Editor.models.Setting?b:new TGE_Editor.models.Setting}})}(jQuery);var TGE_Editor=TGE_Editor||{};TGE_Editor.modals=TGE_Editor.modals||{},function(a){a(function(){TGE_Editor.modals.ModalSteps=TVE_Dash.views.Modal.extend({stepClass:".tge-modal-step",currentStep:0,$step:null,events:{"click .tge-modal-next-step":"next","click .tge-modal-prev-step":"prev"},afterRender:function(){return this.steps=this.$el.find(this.stepClass).hide(),this.gotoStep(0),this},gotoStep:function(a){var b=this.steps.hide().eq(a).show(),c=this;return this.$step=b,setTimeout(function(){c.input_focus(b)},50),this.currentStep!==a&&(this.currentStep=a,this.trigger("modal:step_changed",parseInt(a))),this},next:function(){this.beforeNext(),this.gotoStep(this.currentStep+1),this.afterNext()},prev:function(){this.beforePrev(),this.gotoStep(this.currentStep-1),this.afterPrev()},beforeNext:function(){return this},afterNext:function(){return this},beforePrev:function(){return this},afterPrev:function(){return this},beforeClose:function(){this.$el.live_tooltip("remove"),a(".tvd-toast").remove(),a(".tvd-material-tooltip").remove()}}),TGE_Editor.modals.AddQuestion=TGE_Editor.modals.ModalSteps.extend({className:"tvd-modal-fixed-footer tvd-modal tge-modal",template:TVE_Dash.tpl("modals/add-question"),events:_.extend({},TGE_Editor.modals.ModalSteps.prototype.events,{"click .tge-q-type":"onTypeSelected","click .tvd-modal-submit":"saveQuestion"}),initialize:function(a){TGE_Editor.modals.ModalSteps.prototype.initialize.apply(this,arguments),this.on("modal:step_changed",function(a){switch(a){case 1:this.renderQuestionForm(this._getFormWrapper());break;default:this.$el.css({"max-width":this.data["max-width"]}),this.form_view.remove()}},this)},afterRender:function(){return this.renderTypes(TGE_Editor.globals.question_types),TGE_Editor.modals.ModalSteps.prototype.afterRender.apply(this,arguments),this},input_focus:function(a){},renderTypes:function(a){var b=TVE_Dash.tpl("question/type-card");if(!(a instanceof Backbone.Collection))return!1;a.each(function(a,c,d){this._getListWrapper().append(b({item:a,selected:a.get("id")==this.model.get("q_type")}))},this)},_getListWrapper:function(){return this.$types_list_wrapper||(this.$types_list_wrapper=this.$("#tge-question-types")),this.$types_list_wrapper},_getFormWrapper:function(){return this.$form_wrapper||(this.$form_wrapper=this.$("#tge-question-form")),this.$form_wrapper},renderQuestionForm:function(a){this.$el.css({"max-width":"80%"});var b=_.extend({},this.model.defaults,{q_type:this.model.get("q_type"),position:this.model.get("position"),answers:new TGE_Editor.collections.Answers,id:""});this.model.clear({silent:!0}),this.model.set(b),this.form_view=new TGE_Editor.views.FormQuestion({model:this.model}),this.form_view.render(),a.html(this.form_view.$el)},onTypeSelected:function(b){this.model.set("q_type",b.currentTarget.dataset.id),TVE_Dash.select_card(a(b.currentTarget),this._getListWrapper().find(".tge-q-type"))},next:function(){this.beforeNext()&&(this.gotoStep(this.currentStep+1),this.afterNext())},beforeNext:function(){return!!this.model.get("q_type")||(TVE_Dash.err(TGE_Editor.t.select_question_type),!1)},saveQuestion:function(){if(this.model.isValid()){var a=this;0===window.tge_app_view.questions.length&&(this.model.set("start","1"),this.model.set("position",{x:tge_app_view.startFlow.position().x+tge_app_view.startFlow.get("size").width/2,y:tge_app_view.startFlow.position().y+100})),window.tge_app_view.saving(),TVE_Dash.showLoader(),this.model.save(null,{success:function(b,c,d){window.tge_app_view.questions.add(a.model),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved(),a.close()}})}}}),TGE_Editor.modals.DeleteQuestion=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/delete-question"),events:{"click .tve-confirm-delete-action":"delete"},afterRender:function(){this.$el.addClass("tvd-red")},delete:function(){var a=window.tge_app_view.questions.findWhere({id:this.model.id});if(a instanceof TGE_Editor.models.Question){var b=this;TVE_Dash.showLoader(),a.destroy({success:function(a,c){TVE_Dash.success(TGE_Editor.t.question_success_deleted),b.model.remove(),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(TGE_Editor.t.question_error_deleted)},complete:function(){TVE_Dash.hideLoader(),b.close()}})}}}),TGE_Editor.modals.EditQuestion=TGE_Editor.modals.AddQuestion.extend({renderQuestionForm:function(a){this.$el.css({"max-width":"80%"}),this.form_view=new TGE_Editor.views.FormQuestionEdit({model:this.model}),this.form_view.render(),a.html(this.form_view.$el)},afterRender:function(){TGE_Editor.modals.AddQuestion.prototype.afterRender.apply(this,arguments),this.next(),this.$(".tge-modal-prev-step").html(TGE_Editor.t.change_question_type),this.$(".tvd-modal-title").html(TGE_Editor.t.edit_question)},saveQuestion:function(){if(this.model.isValid()){var a=this;TVE_Dash.showLoader(),window.tge_app_view.saving(),this.model.save(null,{success:function(a,b,c){window.tge_app_view.graph.getCell(a.get("id")).set(a.toDeepJSON())},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved(),a.close()}})}}})})}(jQuery);var TGE_Editor=TGE_Editor||{};TGE_Editor.views=TGE_Editor.views||{},TGE_Editor.globals=TGE_Editor.globals||{},TGE_Editor.const=TGE_Editor.const||{},_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},TGE_Editor.const={answers_per_row:5,answer:{margin:{left:20,bottom:10},image:{size:{width:100,height:100}},size:{width:150,height:30}},question:{image:{size:{width:100}},size:{height:30}},navigator:{size:{width:250,height:250}},paper:{size:{width:5e3,height:5e3}}},TGE_Editor.globals.question_types=new Backbone.Collection(TGE_Editor.question_types);var weights_setting=new TGE_Editor.models.WeightsSetting({value:TGE_Editor.quiz.display_weight,key:"display_weight",label:"Weights"}),tags_setting=new TGE_Editor.models.TagsSetting({value:TGE_Editor.quiz.display_tags,key:"display_tags",label:"Tags"});TGE_Editor.globals.settings=new TGE_Editor.collections.Settings,TGE_Editor.globals.settings.add(weights_setting),TGE_Editor.globals.settings.add(tags_setting),TGE_Editor.globals.settings.on("change",function(){this.save()}),function(a){a(function(){TGE_Editor.views.AppView=Backbone.View.extend({el:"#tge-app",selectedCell:null,notMovableModels:["tge.Answer","tge.AnswerImage","tge.NewQuestion","tge.StartFlow"],sidebarList:null,costs:[],$saving_status:null,attrLinks:{".connection":{stroke:"#87548d","stroke-width":2}},events:{scroll:"on_scroll"},initialize:function(){this.$scrollers=a(".tge-scroll"),this.$collapseBtn=a("#tge-slide-cp"),this.$collapseBtn.click(_.bind(this.toggle_control_panel,this)),this.$saving_status=a("#tge-saving-status"),this.sidebarList=a("#tge-items-list"),this.questions=new TGE_Editor.collections.Questions(TGE_Editor.questions),this.answers=new Backbone.Collection,this.$add_new_question=a("#tge-add-new-question").click(this.add_new_question),this.listenTo(this.questions,"add",function(a){this.loadNewQuestion(a)},this),this.listenTo(this.questions,"remove",function(){this.render_sidebar_list()},this),this.listenTo(this.questions,"change:text",function(){this.updateAnswersCollection(),this.render_sidebar_list()}),this.render_sidebar_list(),this.initializePaper(),this.initializeNavigatorPaper(),this.loadQuestions(),this.initializeStart(),this.updateAnswersCollection(),this.int_navigator(),this.$scrollers.hide()},initializeNewQuestionButton:function(){_.isUndefined(this.newQuestionButton)&&(this.newQuestionButton=new joint.shapes.tge.NewQuestion({id:"new-question"}),this.graph.addCell(this.newQuestionButton));var a={x:TGE_Editor.const.paper.size.width/2-this.$el.width()/2+50,y:50};this.newQuestionButton.position(a.x,a.y)},initializeStart:function(){_.isUndefined(this.startFlow)&&(this.startFlow=new joint.shapes.tge.StartFlow({id:"start"}),this.graph.addCell(this.startFlow));var a=TGE_Editor.const.paper.size.width,b={x:a/2-this.startFlow.get("size").width/2,y:50};this.startFlow.position(b.x,b.y);var c=this.graph.get("cells").findWhere({start:"1"});c&&this.createStartLink(c)},createStartLink:function(a){this.create_link({id:"start",port:"start-port",selector:"g:nth-child(1) > g:nth-child(5) > circle:nth-child(1)"},{id:a.id,port:"q-in-port-"+a.id,selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)"})},initializeNavigatorPaper:function(){function b(a){var b=d.$el.scrollTop(),c=d.$el.scrollLeft();switch(a){case"bottom":if(b>=TGE_Editor.const.paper.size.height-h.height)return;b+=e,d.$el.scrollTop(b),d.$nav_handler.css({top:b/g});break;case"top":if(b<=-e)return;b-=e,d.$el.scrollTop(b),d.$nav_handler.css({top:b/g});break;case"right":if(c>=TGE_Editor.const.paper.size.width-h.width)return;c+=e,d.$el.scrollLeft(c),d.$nav_handler.css({left:c/f});break;case"left":if(c<=-e)return;c-=e,d.$el.scrollLeft(c),d.$nav_handler.css({left:c/f})}}var c=new joint.dia.Paper({preventContextMenu:!1,el:a("#tge-nav-paper"),width:TGE_Editor.const.navigator.size.width,height:TGE_Editor.const.navigator.size.height,model:this.graph});this.scale=TGE_Editor.const.navigator.size.width/this.paper.options.width,c.scale(this.scale);var d=this,e=10,f=(this.$el.scrollTop(),this.$el.scrollLeft(),TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width),g=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height,h={width:this.$el.width(),height:this.$el.height()};setTimeout(function(){d.$el.animate({scrollLeft:TGE_Editor.const.paper.size.width/2-h.width/2},500,"swing")},500);var i;this.$scrollers.on("mouseover",function(a){var c=a.target.dataset.dir;i=setInterval(function(){b(c)},10)}).on("mouseout",function(){clearInterval(i)})},initializePaper:function(){var a=this;this.graph=new joint.dia.Graph,this.paper=new joint.dia.Paper({preventContextMenu:!1,restrictTranslate:!0,el:this.$("#tge-paper"),width:TGE_Editor.const.paper.size.width,height:TGE_Editor.const.paper.size.height,model:this.graph,gridSize:1,snapLinks:{radius:50},linkPinning:!1,markAvailable:!0,clickThreshold:1,defaultLink:new tgeLink({router:{name:"manhattan"},connector:{name:"rounded"},attrs:this.attrLinks}),interactive:function(a){return!(a.model instanceof joint.dia.Link)||{vertexAdd:!1}},validateConnection:function(b,c,d,e,f,g){var h=b.model.get("question_id");if(h){if(e.getAttribute("qid")===h+"q")return!1}var i=c.getAttribute("port"),j=a.graph.getConnectedLinks(b.model,{outbound:!0});return!(_.filter(j,function(a){return a.get("source").port==i}).length>1||c&&"in"===c.getAttribute("port-group")||e&&"out"===e.getAttribute("port-group")||c&&e&&c.getAttribute("qid")===e.getAttribute("qid")||b===d)}}),this.paper.on("cell:pointerdown",this.onCellPointerdown,this),this.paper.on("cell:pointerup",this.onCellPointerup,this),this.paper.on("link:connect",this.onLinkConnect,this),this.paper.on("cell:mouseover",this.onCellMouseover,this),this.paper.on("cell:mouseout",this.onCellMouseout,this),this.graph.on("remove",this.onGraphRemove,this),this.graph.on("add",this.onGraphAdd,this),this.graph.on("change:position",this.onGraphChangePosition,this)},loadQuestions:function(){this.graph.fromJSON({cells:TGE_Editor.questions},{silent:!1});var a=this.graph.get("cells").where({type:"tge.Answer"}),b=this.graph.get("cells").where({type:"tge.AnswerImage"});_.each(_.union(a,b),function(a,b,c){if(a.get("next_question_id")){var d,e;d={id:a.get("id"),selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"a-port-"+a.get("id")},e={id:a.get("next_question_id")+"q",selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-"+a.get("next_question_id")+"q"},this.create_link(d,e)}},this);var c=this.graph.get("cells").where({type:"tge.Question"});_.each(c,function(a,b,c){if(a.get("next_question_id")){var d,e;d={id:a.get("id"),selector:"g:nth-child(1) > g:nth-child(4) > circle:nth-child(1)",port:"q-out-port-"+a.get("id")},e={id:a.get("next_question_id"),selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-"+a.get("next_question_id")},this.create_link(d,e)}},this)},loadNewQuestion:function(a){var b,c=a.toDeepJSON(),d=this.graph.getCell(c.id),e=-1,f=0;if(d?(d.set(c),b=d):(b=new joint.shapes.tge.Question(_.extend(c,{})),this.graph.addCell(b)),_.each(c.answers,function(a,d,g){d&&d%TGE_Editor.const.answers_per_row==0&&(e=-1,f++),e++,this.loadNewAnswer(a,b,c,e,f)},this),1==b.get("start")){this.createStartLink(b);var g=b.position(),h={x:g.x-b.get("size").width/2,y:g.y};this.selectedCell=this.paper.findViewByModel(b),b.position(h.x,h.y),b.loadAnswers(),this.paper.trigger("cell:pointerup",this.selectedCell),this.render_sidebar_list()}},loadNewAnswer:function(a,b,c,d,e){var f,g=this.graph.getCell(a.id);g?g.set(a):(f=new joint.shapes.tge.Answer(_.extend(a,{col:d,row:e,jQuestion:b.toJSON()})),b.embed(f),this.graph.addCell(f))},create_link:function(a,b){var c={type:"link",source:{id:"qqqq1",selector:"g:nth-child(1) > g:nth-child(4) > circle:nth-child(1)",port:"q-out-port-q1"},target:{id:"q2",selector:"g:nth-child(1) > g:nth-child(3) > circle:nth-child(1)",port:"q-in-port-q2"},router:{name:"manhattan"},connector:{name:"rounded"},embeds:"",z:16,attrs:this.attrLinks};if(a&&(c.source=a),b&&(c.target=b),this.graph.getCell(c.source.id)&&this.graph.getCell(c.target.id)){var d=new tgeLink(c);this.graph.addCell(d)}},disconnect_link:function(a,b){if(a.id&&b.id){var c=new TGE_Editor.models.Disconnecion({source:a,target:b});window.tge_app_view.saving(),c.save(null,{error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){window.tge_app_view.change_automatically_saved()}})}},save_link:function(a,b,c){var d=new TGE_Editor.models.Connection({source:a,target:b});window.tge_app_view.saving(),d.save(null,{error:function(a,b){c.model.disconnect(),TVE_Dash.err(b.responseJSON.data.message)},complete:function(){window.tge_app_view.change_automatically_saved()}})},renderQuestion:function(a){var b=new TGE_Editor.views.QuestionView({model:a});this.sidebarList.append(b.render().$el)},onCellPointerup:function(a,b){this.selectedCell=null;var c=b?b.target.getAttribute("class"):null;if("tge-remove-tool"!==c&&"tge-edit-tool"!==c&&"tge.Question"===a.model.get("type")&&a.model.changed.position){var d=this.questions.findWhere({id:a.model.id});d.set("position",a.model.get("position")),window.tge_app_view.saving(),d.save(null,{complete:function(){window.tge_app_view.change_automatically_saved()}})}this.$scrollers.hide()},onCellPointerdown:function(a){this.selectedCell=a,this.$scrollers.show()},onCellMouseover:function(a){"tge.Question"===a.model.get("type")&&a.$(".tge-question-tools").attr("style","display: inline")},onCellMouseout:function(a){"tge.Question"===a.model.get("type")&&a.$(".tge-question-tools").attr("style","display: none")},onLinkConnect:function(a){if(this.save_link(a.model.get("source"),a.model.get("target"),a),"start"===a.model.get("source").id){var b=this.questions.findWhere({id:a.model.get("target").id});b instanceof Backbone.Model&&b.set("start","1")}else{var c,d=a.model.get("source").id;c=-1!==d.indexOf("a")?this.answers.findWhere({id:d}):this.questions.findWhere({id:d}),c instanceof Backbone.Model&&c.set("next_question_id",a.model.get("target").id)}this.render_sidebar_list()},onGraphRemove:function(a){if(a.isLink()&&!_.isUndefined(a.get("source").id)&&!_.isUndefined(a.get("target").id)){if(this.disconnect_link(a.get("source"),a.get("target")),"start"===a.get("source").id){var b=this.questions.findWhere({id:a.get("target").id});b instanceof Backbone.Model&&b.set("start",null)}else{var c,d=a.get("source").id;c=-1!==d.indexOf("a")?this.answers.findWhere({id:d}):this.questions.findWhere({id:d}),c instanceof Backbone.Model&&c.set("next_question_id",null)}this.render_sidebar_list()}},onGraphAdd:function(a){"tge.Question"===a.get("type")&&a.loadAnswers()},onGraphChangePosition:function(a){this.selectedCell&&-1!==_.indexOf(this.notMovableModels,this.selectedCell.model.get("type"))&&a.set("position",a.previous("position"))},render_questions:function(a,b){if(void 0===b&&(b=0),a instanceof Backbone.Model&&a.get("answers")instanceof Backbone.Collection){a.attributes.level=b,!0!==a.get("rendered")&&this.renderQuestion(a);var c=a.get("next_question_id"),d=null;c&&(d=this.questions.findWhere({id:c.replace("q","")+"q"})),a.get("answers").each(function(a,c,d){if(a.get("next_question_id")){var e=a.get("next_question_id"),f=this.questions.findWhere({id:e.replace("q","")+"q"}),g=b;f instanceof Backbone.Model&&(g++,this.render_questions(f,g))}},this),d instanceof Backbone.Model&&this.render_questions(d,b)}},_get_paths:function(a,b,c,d){if(!_.isUndefined(a)){var e={q:a.get("text"),points:b,path_key:c,paths:[],level:d};return!0!==a.get("rendered")&&(a.attributes.level=d,a.attributes.path=c,this.renderQuestion(a)),a.get("answers").each(function(f,g,h){var i=d;f.get("next_question_id")&&i++;var j=f.get("next_question_id")?f.get("next_question_id"):a.get("next_question_id");j=j||"";var k=this.questions.findWhere({id:j.replace("q","")+"q"}),l=parseInt(f.get("points"));k instanceof Backbone.Model?e.paths.push(this._get_paths(k,b+l,c+":"+f.get("text"),i)):(e.paths.push({path_key:c+":"+f.get("text"),points:f.get("points")}),this.costs.push(b+l))},this),e}},render_sidebar_list:function(){this.sidebarList.empty(),this.questions.each(function(a){a.attributes.rendered=!1});try{this.render_questions(this.questions.findWhere({start:"1"}),0,"Start",0)}catch(a){TVE_Dash.err("Please check the links and break the loops.")}},updateAnswersCollection:function(){this.answers.reset(),this.questions.each(function(a){a.get("answers").each(function(a){this.answers.push(a)},this)},this)},saving:function(){this.$saving_status.html(TGE_Editor.t.saving)},change_automatically_saved:function(){this.$saving_status.html('<span class="tvd-icon-question-circle"></span><span>'+TGE_Editor.t.changes_automatically_saved+"</span>")},toggle_control_panel:function(b){var c=this;a("#tge-control-panel").toggleClass("tge-cp-collapsed"),this.$el.toggleClass("tge-cp-collapsed"),setTimeout(function(){b.cp_collapsed=c.$el.hasClass("tge-cp-collapsed"),c.trigger("tge:cp:collapse",b)},700)},int_navigator:function(){a("#tge-nav-control").click(function(){var b=a(this);if(b.hasClass("tvd-icon-minus"))return a("#tge-nav-paper").css({height:0}),b.removeClass("tvd-icon-minus").addClass("tvd-icon-plus"),void b.attr("data-tooltip",TGE_Editor.t.maximize);a("#tge-nav-paper").css({height:250}),b.removeClass("tvd-icon-plus").addClass("tvd-icon-minus"),b.attr("data-tooltip",TGE_Editor.t.minimize)});var b={get_size:function(a){var b={width:10,height:10},c=TGE_Editor.const.paper.size.width,d=TGE_Editor.const.paper.size.height,e={width:a.width/c,height:a.height/d};return b.width=TGE_Editor.const.navigator.size.width*e.width,b.height=TGE_Editor.const.navigator.size.height*e.height,{width:b.width+"px",height:b.height+"px"}}},c=this,d={width:this.$el.width(),height:this.$el.height()};this.$nav_handler=a("#tge-nav-handler");var e=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,f=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;this.$nav_handler.css(b.get_size(d)),this.$nav_handler.draggable({containment:"parent",drag:function(a,b){var c=b.position.left*e,d=b.position.top*f;tge_app_view.$el.scrollLeft(c),tge_app_view.$el.scrollTop(d)}}),this.on("tge:cp:collapse",function(a){var d={width:this.$el.width(),height:this.$el.height()},e=b.get_size(d);c.$nav_handler.css(e)})},on_scroll:function(a){var b=a.target.scrollTop,c=a.target.scrollLeft,d=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,e=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;this.$nav_handler.css({top:b/e,left:c/d})},add_new_question:function(){var a={x:150+tge_app_view.$el.scrollLeft(),y:150+tge_app_view.$el.scrollTop()},b=new TGE_Editor.models.Question({position:a});TVE_Dash.modal(TGE_Editor.modals.AddQuestion,{model:b,dismissible:!1,"max-width":"40%"})}}),TGE_Editor.views.FormQuestion=Backbone.View.extend({template:TVE_Dash.tpl("question/form"),answers_views:[],events:{"click #tge-qf-add-description":"add_description_field","click #tge-gf-delete-description":"remove_description_field","click #tge-qf-add-answer":"add_answer","keyup #tge-question-description-textarea":function(a){a.stopPropagation()},"keyup .tge-answer-text":function(a){a.stopPropagation(),13===a.keyCode&&this.add_answer()}},initialize:function(){this.model.attributes.text=_.unescape(this.model.attributes.text),this.model.attributes.description=_.unescape(this.model.attributes.description),this.model.attributes.text=_.escape(this.model.attributes.text),this.model.attributes.description=_.escape(this.model.attributes.description),this.listenTo(this.model.get("answers"),"add",this.renderAnswerForm),this.listenTo(this.model.get("answers"),"remove",function(a){1==a.get("is_right")&&this.model.get("answers").first().set("is_right",1)})},render:function(){return this.$el.html(this.template({item:this.model})),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),"personality"===TGE_Editor.quiz.quiz_type&&this.render_weight_switcher(),this.render_tags_switcher(),TVE_Dash.data_binder(this),this.add_answer(),this},render_weight_switcher:function(){new TGE_Editor.views.Switcher({model:TGE_Editor.globals.settings.get_model("display_weight"),el:this.$("#tge-points-switcher")}).render()},render_tags_switcher:function(){new TGE_Editor.views.TagsSwitcher({model:TGE_Editor.globals.settings.get_model("display_tags"),el:this.$("#tge-tags-switcher")}).render()},renderAnswerForm:function(a){var b=this,c=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.model.get("q_type"))});if(c instanceof Backbone.Model&&"function"==typeof TGE_Editor.views["FormAnswer"+TVE_Dash.upperFirst(c.get("key"))]){var d=new(TGE_Editor.views["FormAnswer"+TVE_Dash.upperFirst(c.get("key"))])({model:a,collection:this.model.get("answers")});this.answers_views.push(d),this._getAnswersWrapper().append(d.render().$el).sortable({handle:this.$(".tge-sort-handle"),placeholder:"tge-sortable-placeholder",sort:function(a,b){b.placeholder.css({border:"2px dashed gray",width:b.helper.css("width"),height:b.helper.css("height"),margin:b.helper.css("margin")})},update:function(){b.update_answers_order()}})}},update_answers_order:function(){_.each(this.answers_views,function(a,b,c){a.model.attributes.order=a.$el.index()},this)},_getAnswersWrapper:function(){return this.$answers_wrapper||(this.$answers_wrapper=this.$("#tge-answers-wrapper")),this.$answers_wrapper},add_description_field:function(){this.$("#tge-question-description").show(),this.$("#tge-qf-add-description").hide(),this.$("#tge-question-description-textarea").trigger("autoresize").focus().select()},add_answer:function(){if(this.model.get("answers").findWhere(2==this.model.get("q_type")?{image:""}:{text:""})instanceof Backbone.Model)return void TVE_Dash.err(2==this.model.get("q_type")?TGE_Editor.t.invalid_image_answer:TGE_Editor.t.invalid_text_answer);var a=TGE_Editor.globals.question_types.findWhere({id:parseInt(this.model.get("q_type"))}),b="Answer";a instanceof Backbone.Model&&"function"==typeof TGE_Editor.models[b+TVE_Dash.upperFirst(a.get("key"))]&&(b+=TVE_Dash.upperFirst(a.get("key")));var c=new TGE_Editor.models[b]({order:this.model.get("answers").length});"right_wrong"===TGE_Editor.quiz.quiz_type&&(c.set("points",0),0===this.model.get("answers").length&&(c.set("is_right",1),c.set("points",1))),"personality"===TGE_Editor.quiz.quiz_type&&c.set("result_id",0),this.model.get("answers").push(c)},remove_description_field:function(){this.model.set("description",""),this.$("#tge-qf-add-description").html(TGE_Editor.t.add_description),this.$("#tge-question-description").hide(),this.$("#tge-qf-add-description").show()},renderAnswers:function(a){this.answers_views=[],a instanceof Backbone.Collection&&a.each(function(a,b,c){this.renderAnswerForm(a)},this)},renderImagePicker:function(a){new TGE_Editor.views.ImagePicker({model:this.model,el:a}).render()}}),TGE_Editor.views.FormQuestionEdit=TGE_Editor.views.FormQuestion.extend({render:function(){return this.$el.html(this.template({item:this.model})),this.model.get("description").length&&this.$("#tge-qf-add-description").html(TGE_Editor.t.edit_description),this.render_tags_switcher(),TVE_Dash.data_binder(this),this.renderAnswers(this.model.get("answers")),this.renderImagePicker(this.$("#tge-qf-image-loader")),
"personality"===TGE_Editor.quiz.quiz_type&&this.render_weight_switcher(),this}}),TGE_Editor.views.FormAnswer=Backbone.View.extend({className:"tvd-white tge-answer "+("personality"===TGE_Editor.quiz.quiz_type?"tge-personality-answer":""),events:{"click .tvd-icon-trash-o":function(){this.collection.remove(this.model),this.remove()}},initialize:function(){this.model.attributes.text=_.unescape(this.model.attributes.text),this.model.attributes.text=_.escape(this.model.attributes.text),this.listenTo(TGE_Editor.globals.settings.get_model("display_weight"),"change:value",this.toggle_points),this.listenTo(TGE_Editor.globals.settings.get_model("display_tags"),"change:value",this.toggle_tags),this.listenTo(this.model,"change:is_right",function(a){this._set_wrong(a.collection),a.attributes.is_right=1,a.attributes.points=1}),this.listenTo(this.model,"change:points",function(){this.$('input[data-bind="points"]').removeClass("tvd-invalid tvd-tooltipped")})},toggle_tags:function(a){a.get("value")?this.tags_view.$el.show():this.tags_view.$el.hide()},toggle_points:function(a,b){this._get_points_column().css({display:b?"block":"none"})},render:function(){var a=this;return this.$el.html(this.template({item:this.model})),"right_wrong"===TGE_Editor.quiz.quiz_type?this._render_right_wrong_input():this._render_points_input(),"personality"===TGE_Editor.quiz.quiz_type&&this.render_results_options(),this.render_tags(),TVE_Dash.data_binder(this),setTimeout(function(){TVE_Dash.materialize(a.$el),a.$("input.tge-answer-text").first().focus().select()},10),this},render_tags:function(){this.tags_view=new TGE_Editor.views.TagsView({model:this.model,el:this.$(".tge-tags-column")}),this.tags_view.render(),this.toggle_tags(TGE_Editor.globals.settings.get_model("display_tags"))},render_results_options:function(){this.results_view=new TGE_Editor.views.QuizResults({collection:new Backbone.Collection(TGE_Editor.quiz.results),model:this.model}),this._get_points_column().before(this.results_view.render().$el),TGE_Editor.globals.settings.get_model("display_weight").is_checked()?this._get_points_column().css({display:"block"}):this._get_points_column().css({display:"none"})},_render_points_input:function(){var a=TVE_Dash.tpl("answer/form/points");this._get_points_column().html(a({item:this.model}))},_render_right_wrong_input:function(){var a=TVE_Dash.tpl("answer/form/right_wrong");this._get_points_column().html(a({item:this.model}))},_get_points_column:function(){return this.$points_column||(this.$points_column=this.$(".tge-points-column")),this.$points_column},_set_wrong:function(a){a.each(function(a){a.attributes.is_right=0,a.attributes.points=0})}}),TGE_Editor.views.FormAnswerImage=TGE_Editor.views.FormAnswer.extend({template:TVE_Dash.tpl("answer/form/image"),render:function(){return TGE_Editor.views.FormAnswer.prototype.render.apply(this,arguments),this.renderImagePicker(this.$(".tge-image-loader")),this},renderImagePicker:function(a){new TGE_Editor.views.ImagePickereAnswer({model:this.model,el:a}).render()}}),TGE_Editor.views.FormAnswerButton=TGE_Editor.views.FormAnswer.extend({template:TVE_Dash.tpl("answer/form/button"),events:_.extend({},TGE_Editor.views.FormAnswer.prototype.events,{})}),TGE_Editor.views.ImagePicker=Backbone.View.extend({template:TVE_Dash.tpl("image/form"),events:{"click .tge-add-image":"open_media","click .tge-remove-image":"remove","click .tge-change-image":"open_media"},render:function(){return this.$el.html(this.template({item:this.model})),this.$form=this.$(".tge-image-form"),this.$buttonAdd=this.$(".tge-add-image"),this.$buttonRemove=this.$(".tge-remove-image"),this.$buttonChange=this.$(".tge-change-image"),this.$placeholder=this.$(".tge-image-placeholder"),this.load_image(),TVE_Dash.data_binder(this),this},open_media:function(){var a=this,b=wp.media({title:TGE_Editor.t.media.question_title});b.on("select",function(){var c=b.state().get("selection").first().toJSON();c.sizes.thumbnail||(c.sizes.thumbnail=c.sizes.full),a.$placeholder.removeClass("tvd-invalid tvd-tooltipped"),a.model.set("image",new TGE_Editor.models.Image(c)),a.load_image()}),b.open()},remove:function(){this.$placeholder.css({"background-image":"url('"+TGE_Editor.assets_url+"/css/images/image-placeholder.png')","background-position":"50% 30%","background-size":""}),this.$form.removeClass("tge-has-image"),this.model.set("image",null),this.$buttonAdd.css({display:"block"})},load_image:function(){this.model.get("image")&&this.model.get("image").get_thumb()&&(this.$placeholder.css({"background-image":"url("+this.model.get("image").get_thumb()+")","background-size":"cover"}),this.$form.addClass("tge-has-image"),this.$buttonAdd.css({display:"none"}))}}),TGE_Editor.views.ImagePickereAnswer=TGE_Editor.views.ImagePicker.extend({template:TVE_Dash.tpl("image/answer")}),TGE_Editor.views.QuizResults=Backbone.View.extend({className:"tge-category-field",template:TVE_Dash.tpl("quiz/responses"),render:function(){return this.$el.html(this.template({item:this.model})),this.$select=this.$("select"),this.collection.each(function(b,c,d){var e=a("<option/>");e.val(b.get("id")),e.text(b.get("text")),this.model.get("result_id")===b.get("id")&&e.attr("selected","selected"),this.$select.append(e)},this),0==this.model.get("result_id")&&this.$select.find('option[value="0"]').attr("selected","selected"),this}}),TGE_Editor.views.QuestionView=Backbone.View.extend({tagName:"li",className:"tvd-collection-item tge-q-item",template:TVE_Dash.tpl("question/item"),events:{click:"onClick"},render:function(){return this.$el.html(this.template({item:this.model})),this.$el.attr("id","tge-question-"+this.model.get("id")),this.$el.css({"border-left-width":2*this.model.get("level")+"px"}),this.model.attributes.rendered=!0,this},highlight_callView:function(a){var b={highlighter:{name:"addClass",options:{className:"tge-opacity"}}};a.highlight(".question-body",b),setTimeout(function(){a.unhighlight(".question-body",b)},150)},onClick:function(){var a=tge_app_view.paper.findViewByModel(this.model.get("id")),b=tge_app_view.graph.getCell(this.model.get("id")),c=tge_app_view.$el.scrollLeft(),d=tge_app_view.$el.scrollTop(),e=this.model.get("position").y-(tge_app_view.$el.height()-b.get("size").height)/2,f=this.model.get("position").x-(tge_app_view.$el.width()-b.get("size").width)/2,g=TGE_Editor.const.paper.size.width/TGE_Editor.const.navigator.size.width,h=TGE_Editor.const.paper.size.height/TGE_Editor.const.navigator.size.height;if(!0===tge_app_view.scrolling||d===e&&c===f)return void this.highlight_callView(a);var i=this,j=e/h,k=f/g;tge_app_view.$nav_handler.animate({top:j<0?0:j,left:k<0?0:k}),tge_app_view.scrolling=!0,tge_app_view.$el.animate({scrollTop:e+"px",scrollLeft:f+"px"},600,"swing",function(){i.highlight_callView(a),tge_app_view.scrolling=!1})}}),TGE_Editor.views.Switcher=Backbone.View.extend({template:TVE_Dash.tpl("question/switcher"),events:{"change input":function(){this.model.set("value",!this.model.attributes.value)}},render:function(){return this.$el.html(this.template({item:this.model})),this}}),TGE_Editor.views.TagsSwitcher=TGE_Editor.views.Switcher.extend({template:TVE_Dash.tpl("question/tags-switcher"),initialize:function(){this.listenTo(this.model,"change:value",function(){this.toggle_texts(!0)})},render:function(){return TGE_Editor.views.Switcher.prototype.render.apply(this,arguments),this.toggle_texts(),this},toggle_texts:function(b){var c=this.model.get("value"),d=this.$(".tvd-switch").first(),e=c?TGE_Editor.t.tags_switcher_off_tooltip:TGE_Editor.t.tags_switcher_on_tooltip,f=c?TGE_Editor.t.tags_switcher_on_toast:TGE_Editor.t.tags_switcher_off_toast,g=c?"green accent-5":"yellow accent-5";d.attr("data-tooltip",e),b&&(a(".tvd-toast").remove(),Materialize.toast(f,3e4,"tvd-toast tvd-pointer tge-tags-toast "+g,function(){},"bottom"),a(".tvd-toast").click(function(b){a(this).remove(),b.stopPropagation()}))}}),TGE_Editor.views.TagsView=Backbone.View.extend({template:TVE_Dash.tpl("answer/tags"),render:function(){this.$el.html(this.template({item:this.model}));var a=this.$("input");return this.$chips=a.materialtags({maxTags:5,trimValue:!0,confirmKeys:[9,13,44,188]}),this}})})}(jQuery),joint.shapes.tge={},joint.shapes.tge.Question=joint.dia.Element.extend({markup:'<g class="rotatable"><g class="scalable"><rect class="question-body"/></g><text class="question-text"/><image class="question-image"/></g>',portMarkup:'<circle class="port-body" r="7" fill="gray" />',toolsMarkup:'<g class="tge-question-tools"><image class="tge-remove-tool" width="13" height="14"/><image class="tge-edit-tool" width="14" height="15"/><image class="tge-duplicate-tool" width="14" height="14"/></g>',defaults:joint.util.deepSupplement({position:{x:0,y:0},type:"tge.Question",attrs:{".":{magnet:!1},".question-body":{rx:"4px",ry:"4px",fill:"#595c60",filter:{name:"dropShadow",args:{dx:2,dy:2,blur:3}}},".question-image":{x:0,y:0,width:TGE_Editor.const.question.image.size.width,preserveAspectRatio:"xMidYMid slice"},".question-text":{ref:".question-body",fill:"white","ref-x":.5,"ref-y":15,"x-alignment":"middle","font-size":"13px","font-family":"Arial"},".tge-question-tools>image":{preserveAspectRatio:"xMidYMid meet"},".tge-remove-tool":{ref:".question-body","ref-x":7,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}},".tge-duplicate-tool":{ref:".question-body","ref-dx":-42,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}},".tge-edit-tool":{ref:".question-body","ref-dx":-20,"ref-y":5,filter:{name:"dropShadow",args:{dx:0,dy:0,blur:2}}}},ports:{groups:{in:{position:{name:"top"}},out:{position:{name:"bottom"}}},items:[]}},joint.dia.Element.prototype.defaults),initialize:function(){this.on("change:text",function(a,b,c){this.attr(".question-text/text",this.get_text())}),this.on("change:image",function(){this.attr(".question-image/xlink:href",this.get_image()),this.auto_resize(),this.loadAnswers(),this.attr(".question-text/text",this.get_text())}),this.on("change:q_type",function(){this.trigger("change:answers")}),this.on("change:answers",function(){this.loadAnswers(),this.auto_resize(),this.attr(".question-image/height",this.get("size").height),this.attr(".question-text/text",this.get_text())},this),this.auto_resize(),this.initializePorts(),this.attr(".question-text/text",this.get_text()),this.get("image")&&this.attr(".question-image/xlink:href",this.get_image()),this.attr(".tge-remove-tool/xlink:href",TGE_Editor.icons.delete),this.attr(".tge-edit-tool/xlink:href",TGE_Editor.icons.edit),this.attr(".tge-duplicate-tool/xlink:href",TGE_Editor.icons.duplicate),joint.dia.Element.prototype.initialize.apply(this,arguments)},loadAnswers:function(){var a=-1,b=0,c=_.map(this.getEmbeddedCells(),"id"),d=_.map(this.get("answers"),"id"),e=_.difference(c,d);_.each(e,function(a,b,c){window.tge_app_view.graph.getCell(a).remove()},this);var f=_.sortBy(this.get("answers"),function(a){return a.order});_.each(f,function(c,d,e){d&&d%TGE_Editor.const.answers_per_row==0&&(a=-1,b++),a++,this.loadAnswer(c,a,b)},this)},loadAnswer:function(a,b,c){var d=this.graph.getCell(a.id),e=this.toJSON();if(d)d.set(_.extend({},a,{col:b,row:c,jQuestion:{position:e.position,image:e.image,text_size:e.text_size,q_type:e.q_type}})),d.trigger(2==this.get("q_type")?"change:image":"change:text");else{var f=new joint.shapes.tge.Answer(_.extend(a,{col:b,row:c,jQuestion:{position:e.position,image:e.image,text_size:e.text_size,q_type:e.q_type}}));this.embed(f),this.graph.addCell(f)}},get_image:function(){return null===this.get("image")?"":this.get("image").sizes&&this.get("image").sizes.thumbnail?"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.thumbnail.url:""},get_text:function(){var a=this.get("size").width;if(a-=2*TGE_Editor.const.answer.margin.left,0===this.get("answers").length)return this.get("text");var b=_.unescape(this.get("text")),c=this.get("text_size");c=joint.util.measureText(b,{fontSize:this.attr(".question-text/font-size")}),this.set("text_size",c),this.get("q_type")&&this.get("image")?(this.attr(".question-text/x-alignment",null),this.attr(".question-text/ref-x",null),this.attr(".question-text/x",120),a-=105):(this.attr(".question-text/x-alignment","middle"),this.attr(".question-text/ref-x",.5),this.attr(".question-text/x",null));var d,e=c.width<a;for(e||(a-=10,d="...");!e;)b=b.slice(0,b.length-1),c=joint.util.measureText(b,{fontSize:this.attr(".question-text/font-size")}),e=c.width<a;return d?b+d:b},initializePorts:function(){var a={".port-body":{magnet:!0,stroke:"white","stroke-width":1,qid:this.get("id")}};this.get("ports").items.push({id:"q-in-port-"+this.get("id"),group:"in",attrs:a}),this.get("ports").items.push({id:"q-out-port-"+this.get("id"),group:"out",attrs:a})},auto_resize:function(){var a=this._calculate_width(),b=this._calculate_height();b+=TGE_Editor.const.question.size.height,this.attr(".question-body/width",a),this.attr(".question-body/height",b),this.attr(".question-image/height",b),this.resize(a,b)},_calculate_width:function(){var a=this.get("answers").length,b=TGE_Editor.const.answers_per_row,c=TGE_Editor.const.answer.margin.left,d=1==this.get("q_type")?TGE_Editor.const.answer.size.width:TGE_Editor.const.answer.image.size.width,e=a*d+c*(a+1);return a>=b&&(e=b*d+c*(b+1)),this.get("image")&&(e+=TGE_Editor.const.question.image.size.width),e||1},_calculate_height:function(){var a=this.get("answers").length,b=Math.ceil(a/TGE_Editor.const.answers_per_row);return b*(1==this.get("q_type")?TGE_Editor.const.answer.size.height:TGE_Editor.const.answer.image.size.height)+b*TGE_Editor.const.answer.margin.bottom+25||1},save:function(){new TGE_Editor.models.Question(this.toJSON()).save()}}),joint.shapes.tge.QuestionView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments)},render:function(){joint.dia.ElementView.prototype.render.apply(this,arguments),this.renderTools(),this.update()},renderTools:function(){var a=this.model.toolsMarkup||this.model.get("toolsMarkup");if(a){var b=V(a);V(this.el).append(b)}},pointerclick:function(a){if("tge-remove-tool"===a.target.getAttribute("class")&&TVE_Dash.modal(TGE_Editor.modals.DeleteQuestion,{model:this.model}),"tge-duplicate-tool"===a.target.getAttribute("class"))return this.duplicate_question();if("tge-edit-tool"===a.target.getAttribute("class")){var b=window.tge_app_view.questions.findWhere({id:this.model.id});TVE_Dash.modal(TGE_Editor.modals.EditQuestion,{model:b,dismissible:!1,"max-width":"40%"})}joint.dia.ElementView.prototype.pointerclick.apply(this,arguments)},duplicate_question:function(){var a=window.tge_app_view.questions.findWhere({id:this.model.id});if(a instanceof Backbone.Model){var b=new TGE_Editor.models.Question(a.toDeepJSON());b.clear_for_duplicate(),window.tge_app_view.saving(),TVE_Dash.showLoader(),b.save(null,{success:function(a,c,d){window.tge_app_view.questions.add(b),window.opener&&window.opener.postMessage({event:"tqb_question_counter_update",number:window.tge_app_view.questions.length},"*")},error:function(a,b){TVE_Dash.err(b.responseJSON.data.message)},complete:function(){TVE_Dash.hideLoader(),window.tge_app_view.change_automatically_saved()}})}}}),joint.shapes.tge.Answer=joint.dia.Element.extend({markup:'<g class="rotatable"><g class="scalable"><rect class="body"/></g><image/><text class="answer-text"/></g>',portMarkup:'<circle class="port-body" r="6" fill="gray" />',defaults:joint.util.deepSupplement({type:"tge.Answer",attrs:{".":{magnet:!1},".body":{width:TGE_Editor.const.answer.size.width,height:TGE_Editor.const.answer.size.height,rx:"3px",ry:"3px",fill:"#797e84"},image:{width:TGE_Editor.const.answer.image.size.width,height:TGE_Editor.const.answer.image.size.height,preserveAspectRatio:"xMidYMid slice"},text:{ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle",fill:"white","font-size":"11px",filter:{name:"dropShadow",args:{blur:1,opacity:1,color:"black"}}}},ports:{groups:{out:{position:{name:"bottom"}}},items:[]}},joint.dia.Element.prototype.defaults),initialize:function(){this.on("change:text",function(){this.attr(".answer-text/text",this.get_text()),this.attr("image/xlink:href",null),this.auto_resize(),this.auto_position()}),this.on("change:image",function(){this.attr("image/xlink:href",this.get_image()),this.attr(".answer-text/text",this.get_text()),this.auto_resize(),this.auto_position()}),this.on("change:is_right",function(){this.style_right_wrong(),this.auto_resize(),this.auto_position()}),this.get("image")&&2==this.get("jQuestion").q_type&&this.attr("image/xlink:href",this.get_image()),this.style_right_wrong(),this.attr(".answer-text/text",this.get_text()),this.auto_position(),this.auto_resize(),this.initializePorts(),joint.dia.Element.prototype.initialize.apply(this,arguments)},initializePorts:function(){var a={".port-body":{magnet:!0,stroke:"#393d44","stroke-width":1,aid:this.get("id")}};this.get("ports").items.push({id:"a-port-"+this.get("id"),group:"out",attrs:a})},auto_resize:function(){var a=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.width:TGE_Editor.const.answer.size.width,b=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.height:TGE_Editor.const.answer.size.height;this.attr(".body/width",a),this.attr(".body/height",b),this.get("image")&&2==this.get("jQuestion").q_type?(this.attr("image/width",TGE_Editor.const.answer.image.size.width),this.attr("image/height",TGE_Editor.const.answer.image.size.height)):(this.attr("image/width",0),this.attr("image/height",0)),this.resize(a,b)},auto_position:function(){var a=this.get("jQuestion").position.x,b=this.get("jQuestion").position.y,c=this.get("jQuestion").image,d=this.get("jQuestion").text_size,e=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.width:TGE_Editor.const.answer.size.width,f=2==this.get("jQuestion").q_type?TGE_Editor.const.answer.image.size.height:TGE_Editor.const.answer.size.height,g=this.get("col"),h=this.get("row");b+=Math.round(d.height)+25,a+=TGE_Editor.const.answer.margin.left*(g?g+1:1)+g*e,b+=f*h+TGE_Editor.const.answer.margin.bottom*h,c&&(a+=TGE_Editor.const.question.image.size.width),this.set("position",{x:a,y:b})},get_image:function(){return null===this.get("image")?"":"string"==typeof this.get("image")?this.get("image"):this.get("image")instanceof Backbone.Model?this.get("image").get("sizes").thumbnail.url:this.get("image").sizes.thumbnail.url},get_text:function(){if(2==this.get("jQuestion").q_type)return this.get("points")+"p";var a=this.get("points")+"p - "+_.unescape(this.get("text"));return a.length<=24?a:a.slice(0,24)+"..."},style_right_wrong:function(){var a=2==this.get("jQuestion").q_type?4:2;this.attr(".body/stroke",1==this.get("is_right")?"#62c343":"red"),this.attr(".body/stroke-width",1==this.get("is_right")?a:"0")}}),joint.shapes.tge.StartFlow=joint.dia.Element.extend({markup:'<g class="rotatable" style="cursor: pointer"><g class="scalable"><rect class="body"/></g><text/><g><g class="video-icon"><circle class="bg-video-icon" r="9" fill="white" transform="translate(20,19)"></circle><path class="path1" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM12 9l12 7-12 7z"></path></g></g></g>',portMarkup:'<circle class="port-body" r="7" fill="gray" />',defaults:joint.util.deepSupplement({type:"tge.StartFlow",size:{width:130,height:40},ports:{groups:{out:{position:{name:"bottom"}}},items:[]},attrs:{".":{magnet:!1},".body":{width:130,height:40,fill:"white",rx:3,ry:3,stroke:"#595c60","stroke-width":.5},".path1":{fill:"#87548d",transform:"translate(9,8),scale(0.7)"},text:{ref:".body",x:40,"ref-y":.5,"y-alignment":"middle","font-family":"Arial","font-size":"16px","font-weight":"bold",text:TGE_Editor.t.quiz_start,fill:"#87548d"}}},joint.dia.Element.prototype.defaults),initialize:function(){this.initializePorts(),joint.dia.Element.prototype.initialize.apply(this,arguments)},initializePorts:function(){var a={".port-body":{magnet:!0,stroke:"white",fill:"#87548d","stroke-width":2}};this.get("ports").items.push({id:"start-port",group:"out",attrs:a})}}),joint.shapes.tge.StartFlowView=joint.dia.ElementView.extend({pointerclick:function(a){if($(a.target).is("path")||$(a.target).is(".bg-video-icon"))return void TGE_Editor.wistia.start_quiz.play();var b={x:100+tge_app_view.$el.scrollLeft(),y:100},c=new TGE_Editor.models.Question({text:"question",position:b});TVE_Dash.modal(TGE_Editor.modals.AddQuestion,{model:c,dismissible:!1,"max-width":"40%"}),joint.dia.ElementView.prototype.pointerclick.apply(this,arguments)}}),joint.util.measureText=function(a,b){var c=parseInt(b.fontSize,10)||10,d=V("svg").node,e=V("<text><tspan></tspan></text>").node,f=e.firstChild,g=document.createTextNode("");f.setAttribute("font-size",b.fontSize),f.appendChild(g),d.appendChild(e),document.body.appendChild(d);var h=a.split("\n"),i=0;_.each(h,function(a){g.data=a;var b=f.getComputedTextLength();i=Math.max(i,b)});var j=h.length*(1.2*c);return V(d).remove(),{width:i,height:j}};var tgeLink=joint.dia.Link.extend({arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" d="M 10 0 L 0 5 L 10 10 z" />',"</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="9" />','<path transform="scale(.6) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z" />',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join("")}),TGE_Editor=TGE_Editor||{};TGE_Editor.views=TGE_Editor.views||{},function(a){a(function(){var b=a("html");a("html").css({height:window.innerHeight-parseInt(b.css("margin-top"))-4}),window.tge_app_view=new TGE_Editor.views.AppView,TGE_Editor.wistia={},window._wq=window._wq||[],_wq.push({id:"f6sh0ulno2",onReady:function(a){TGE_Editor.wistia.start_quiz=a}})})}(jQuery);